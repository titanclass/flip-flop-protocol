# Logged Event Offsets

The offset of an event is a number in the range `0 ..= N-1`  assigned by a server to an event when it is generated.    

- the first event generated by a server following a restart is assigned a random offset from `0..=N-1`. The aim of this is to make server restarts detectable within a certain probability.

- the offset is incremented modulo `N` for each successive event.  That is, the successor to an event with offset `n` has offset `s(n)` defined as  `s(n) = (n+1) % N`.  

A server must retain the most recent `M` events it has generated, in the order they were created. Note that the offset is not a reliable indicator of the ordering of events as it wraps around to zero.

The client must maintain the offset, `n`, of the most recent, successfully received event for each server.   If no events have been received the client offset `n` is `0`. 

## Event Delivery

The client sends a command or poll with an offset `n`. The server must respond as follows:

Case |Condition |Response
-|-|-
1 |Event `s(n)` is present in history |Event `s(n)` 
2 |Event `n` is present in history and event `s(n)` is not | No event
3 |Otherwise |A recovery event conveying the start (n0) and end (n1) offsets available

The client interprets the response as follows:

Case |Interpretation |Next Action
-|-|-
1 |Success |Poll with offset `s(n)`
2 |Success |Poll or command with offset `n`
3 |Failure |Recovery of client state from event by polling with offset `n0` upto and including offset `n1`.
Transport error |Failure |Poll with offset `n`

Case 3 indicates that the client or server has restarted or the server event buffer has overrun and a number of events have been lost. If the client tracks some aspect of the server's state this must be recovered. The means to do this are application specific, although given a start and end offset, a client can detect when it is in a recovery phase. A recovery
phase begins on receipt of an event indicating the start and end offsets and continues while the client consumes events
from the start offset up to and including the end offset.

Note that the server has to generate at least one event after restart for the restart to be detected.

## Sizes and Probabilities

For this version of the protocol `N = pow(2, 32)`. 

For servers that generate at most one event per command and no spontaneous events `M >= 1`.  Otherwise `M >= 2` and the best value to avoid buffer overruns depends on the queuing dynamics. 

The probability of detecting a server restart is `(N-M)/N` assuming the server quickly fills its event buffer. The probability increases to `(N-1)/N` if the server only generates one event before it is polled.

Event buffer overruns are reliably detected unless the rate of event generation, `rg` greatly exceeds the polling rate `rp`.  The factor is `rg/rp > N`.
